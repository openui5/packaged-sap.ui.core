<!DOCTYPE HTML>

<!--
  Tested class: sap.ui.core.EventBus
-->

<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<script src="../shared-config.js"></script>
	<script id="sap-ui-bootstrap"
		src="../../../../../resources/sap-ui-core.js"
		data-sap-ui-noConflict="true">
	</script>
	<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
	<script src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>

	<script src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>

	<!-- Initialization -->
	<script>
		var oBus = sap.ui.getCore().getEventBus();

		function checkNumberOfListeners(oEventProvider, sEventId, iExpected){
			if(oEventProvider){
				var aRegisteredListeners = sap.ui.base.EventProvider.getEventList(oEventProvider)[sEventId];
				if(aRegisteredListeners && jQuery.isArray(aRegisteredListeners)){
					assert.equal(aRegisteredListeners.length, iExpected, iExpected+" listener(s) subscribed for event "+sEventId);
				}else{
					assert.ok(!oEventProvider.hasListeners(sEventId) && iExpected == 0, "0 listener(s) subscribed for event "+sEventId);
				}
			}else{
				assert.ok(iExpected == 0, "0 listener(s) subscribed for event "+sEventId);
			}
		};

		function checkHandler(bWithListener, sChannelId, sEventId, oData, oThis, sExpectedChannel, sExpectedEventId, sExpectedData, oListener){
			assert.equal(sChannelId, sExpectedChannel, "Expected Channel");
			assert.equal(sEventId, sExpectedEventId, "Expected Event");
			assert.ok(oThis === (bWithListener ? oListener : oBus), "'this' is set as expected - "+(bWithListener ? "Listener" : "EventBus"));
			assert.ok(!!oData, "Data object provided");
			if(sExpectedData){
				assert.equal(oData.data, sExpectedData, "Expected Data");
			}
		};
	</script>

	<!-- Test functions -->
	<script>

		qutils.delayTestStart();

		QUnit.module("Basics");

		QUnit.test("EventBus initialized", function(assert) {
			assert.ok(!!oBus, "Event Bus initialized");
		});

		QUnit.module("(Un-)subscribe");

		QUnit.test("Default channel", function(assert) {
			assert.expect(5);
			var sEventId = "Test1";
			checkNumberOfListeners(oBus._defaultChannel, sEventId, 0);
			var fHandler1 = function(){};
			oBus.subscribe(sEventId, fHandler1);
			checkNumberOfListeners(oBus._defaultChannel, sEventId, 1);
			var fHandler2 = function(){};
			var oObj2 = {};
			oBus.subscribe(sEventId, fHandler2, oObj2);
			checkNumberOfListeners(oBus._defaultChannel, sEventId, 2);
			oBus.unsubscribe(sEventId, fHandler1);
			checkNumberOfListeners(oBus._defaultChannel, sEventId, 1);
			oBus.unsubscribe(sEventId, fHandler2, oObj2);
			checkNumberOfListeners(oBus._defaultChannel, sEventId, 0);
		});

		QUnit.test("Custom channel", function(assert) {
			assert.expect(6);
			var sEventId = "Test2";
			var sChannelId = "TestChannel2";
			checkNumberOfListeners(oBus._mChannels[sChannelId], sEventId, 0);
			var fHandler1 = function(){};
			oBus.subscribe(sChannelId, sEventId, fHandler1);
			checkNumberOfListeners(oBus._mChannels[sChannelId], sEventId, 1);
			var fHandler2 = function(){};
			var oObj2 = {};
			oBus.subscribe(sChannelId, sEventId, fHandler2, oObj2);
			checkNumberOfListeners(oBus._mChannels[sChannelId], sEventId, 2);
			oBus.unsubscribe(sChannelId, sEventId, fHandler1);
			checkNumberOfListeners(oBus._mChannels[sChannelId], sEventId, 1);
			oBus.unsubscribe(sChannelId, sEventId, fHandler2, oObj2);
			checkNumberOfListeners(oBus._mChannels[sChannelId], sEventId, 0);
			assert.ok(!oBus._mChannels[sChannelId], "Unused Channel is cleaned up.");
		});

		QUnit.module("SubscribeOnce");

		QUnit.test("Default channel", function(assert){
			assert.expect(12);
			var sEventId = "Test3";
			checkNumberOfListeners(oBus._defaultChannel, sEventId, 0);

			// two listener subscribeOnce to the same event:
			var fHandler1 = function(sChannel, sEvent, oData){
				checkHandler(false, sChannel, sEvent, oData, this, null, sEventId, null);
			};
			oBus.subscribeOnce(sEventId, fHandler1);
			checkNumberOfListeners(oBus._defaultChannel, sEventId, 1);

			var oObj2 = {};
			var fHandler2 = function(sChannel, sEvent, oData){
				checkHandler(true, sChannel, sEvent, oData, this, null, sEventId, null, oObj2);
			};
			oBus.subscribeOnce(sEventId, fHandler2, oObj2);
			checkNumberOfListeners(oBus._defaultChannel, sEventId, 2);

			oBus.publish(sEventId);

			// after publish they should not be registered anymore
			checkNumberOfListeners(oBus._defaultChannel, sEventId, 0);
		});

		QUnit.test("Custom channel", function(assert){
			assert.expect(12);
			var sEventId = "Test4";
			var sChannelId = "TestChannel4";

			checkNumberOfListeners(oBus._mChannels[sChannelId], sEventId, 0);

			// two listener subscribeOnce to the same event:
			var fHandler1 = function(sChannel, sEvent, oData){
				checkHandler(false, sChannel, sEvent, oData, this, sChannelId, sEventId, null);
			};
			oBus.subscribeOnce(sChannelId, sEventId, fHandler1);
			checkNumberOfListeners(oBus._mChannels[sChannelId], sEventId, 1);

			var oObj2 = {};
			var fHandler2 = function(sChannel, sEvent, oData){
				checkHandler(true, sChannel, sEvent, oData, this, sChannelId, sEventId, null, oObj2);
			};
			oBus.subscribeOnce(sChannelId, sEventId, fHandler2, oObj2);
			checkNumberOfListeners(oBus._mChannels[sChannelId], sEventId, 2);

			oBus.publish(sChannelId, sEventId);

			// after publish they should not be registered anymore
			checkNumberOfListeners(oBus._mChannels[sChannelId], sEventId, 0);
		});


		var oObj11, oObj13, oObj21, oObj23, fHandler11, fHandler12, fHandler13, fHandler14, fHandler21, fHandler22, fHandler23, fHandler24;

		QUnit.module("Publish", {
			beforeEach : function(){
				oObj11 = {id: "Obj11"};
				oObj13 = {id: "Obj13"};

				fHandler11 = function(sChannelId, sEventId, oData){
					checkHandler(true, sChannelId, sEventId, oData, this, null, "Test11", "data11", oObj11);
				};
				fHandler12 = function(sChannelId, sEventId, oData){
					checkHandler(false, sChannelId, sEventId, oData, this, null, "Test12", "data12", null);
				};
				fHandler13 = function(sChannelId, sEventId, oData){
					checkHandler(true, sChannelId, sEventId, oData, this, null, "Test13", null, oObj13);
				};
				fHandler14 = function(sChannelId, sEventId, oData){
					checkHandler(false, sChannelId, sEventId, oData, this, null, "Test14", null, null);
				};

				oObj21 = {id: "Obj21"};
				oObj23 = {id: "Obj23"};

				fHandler21 = function(sChannelId, sEventId, oData){
					checkHandler(true, sChannelId, sEventId, oData, this, "CustomChannel", "Test21", "data21", oObj21);
				};
				fHandler22 = function(sChannelId, sEventId, oData){
					checkHandler(false, sChannelId, sEventId, oData, this, "CustomChannel", "Test22", "data22", null);
				};
				fHandler23 = function(sChannelId, sEventId, oData){
					checkHandler(true, sChannelId, sEventId, oData, this, "CustomChannel", "Test23", null, oObj23);
				};
				fHandler24 = function(sChannelId, sEventId, oData){
					checkHandler(false, sChannelId, sEventId, oData, this, "CustomChannel", "Test24", null, null);
				};

				oBus.subscribe("Test11", fHandler11, oObj11);
				oBus.subscribe("Test12", fHandler12);
				oBus.subscribe("Test13", fHandler13, oObj13);
				oBus.subscribe("Test14", fHandler14);
				oBus.subscribe("CustomChannel", "Test21", fHandler21, oObj21);
				oBus.subscribe("CustomChannel", "Test22", fHandler22);
				oBus.subscribe("CustomChannel", "Test23", fHandler23, oObj23);
				oBus.subscribe("CustomChannel", "Test24", fHandler24);
			},
			afterEach : function(){
				oBus.unsubscribe("Test11", fHandler11, oObj11);
				oBus.unsubscribe("Test12", fHandler12);
				oBus.unsubscribe("Test13", fHandler13, oObj13);
				oBus.unsubscribe("Test14", fHandler14);
				oBus.unsubscribe("CustomChannel", "Test21", fHandler21, oObj21);
				oBus.unsubscribe("CustomChannel", "Test22", fHandler22);
				oBus.unsubscribe("CustomChannel", "Test23", fHandler23, oObj23);
				oBus.unsubscribe("CustomChannel", "Test24", fHandler24);
			}
		});

		QUnit.test("Default Channel, with Listener, with Data", function(assert) {
			assert.expect(5);
			oBus.publish("Test11", {data: "data11"});
		});

		QUnit.test("Default Channel, no Listener, with Data", function(assert) {
			assert.expect(5);
			oBus.publish("Test12", {data: "data12"});
		});

		QUnit.test("Default Channel, with Listener, no Data", function(assert) {
			assert.expect(4);
			oBus.publish("Test13");
		});

		QUnit.test("Default Channel, no Listener, no Data", function(assert) {
			assert.expect(4);
			oBus.publish("Test14");
		});

		QUnit.test("Custom Channel, with Listener, with Data", function(assert) {
			assert.expect(5);
			oBus.publish("CustomChannel", "Test21", {data: "data21"});
		});

		QUnit.test("Custom Channel, no Listener, with Data", function(assert) {
			assert.expect(5);
			oBus.publish("CustomChannel", "Test22", {data: "data22"});
		});

		QUnit.test("Custom Channel, with Listener, no Data", function(assert) {
			assert.expect(4);
			oBus.publish("CustomChannel", "Test23");
		});

		QUnit.test("Custom Channel, no Listener, no Data", function(assert) {
			assert.expect(4);
			oBus.publish("CustomChannel", "Test24");
		});
	</script>

</head>
<body>
	<h1 id="qunit-header">QUnit tests: sap.ui.core.EventBus</h1>
	<h2 id="qunit-banner"></h2>
 	<h2 id="qunit-userAgent"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<ol id="qunit-tests"></ol>
</body>
</html>
